<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
        }

        .section {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }

        .char-counter {
            text-align: right;
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 4px;
        }

        .media-upload {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .upload-btn:active {
            opacity: 0.7;
        }

        .upload-btn.secondary {
            background: var(--tg-theme-secondary-bg-color, #e0e0e0);
            color: var(--tg-theme-text-color, #000000);
        }

        input[type="file"] {
            display: none;
        }

        .media-preview {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .media-preview.active {
            display: flex;
        }

        .preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: var(--tg-theme-bg-color, #ffffff);
        }

        .preview-item img {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
        }

        .preview-item video {
            width: 100%;
            max-height: 300px;
        }

        .preview-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-info {
            padding: 12px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 8px;
            font-size: 14px;
        }

        .buttons-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .button-item {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 8px;
            align-items: center;
        }

        .button-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 6px;
            font-size: 14px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .button-item input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
        }

        .btn-remove {
            width: 32px;
            height: 32px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }

        .add-button-btn {
            width: 100%;
            padding: 10px;
            background: transparent;
            border: 2px dashed var(--tg-theme-hint-color, #ccc);
            border-radius: 8px;
            color: var(--tg-theme-hint-color, #999);
            font-size: 14px;
            cursor: pointer;
        }

        .preview-section {
            border: 2px solid var(--tg-theme-button-color, #3390ec);
        }

        .preview-content {
            padding: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 8px;
            margin-top: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .preview-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .preview-button {
            padding: 8px 16px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 6px;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .error-message {
            background: #ff3b30;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .formatting-help {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 8px;
            line-height: 1.5;
        }

        .formatting-help code {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="error-message" id="errorMessage"></div>

    <div class="header">
        <h1>üì¢ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏</h1>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–¥–∏–∞ –∏ –∫–Ω–æ–ø–∫–∞–º–∏</p>
    </div>

    <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="section">
        <div class="section-title">
            <span>üìù</span>
            <span>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</span>
        </div>
        <textarea 
            id="messageText" 
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏...&#10;&#10;–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:&#10;<b>–∂–∏—Ä–Ω—ã–π</b>, <i>–∫—É—Ä—Å–∏–≤</i>, <code>–∫–æ–¥</code>"
            maxlength="4096"
        ></textarea>
        <div class="char-counter">
            <span id="charCount">0</span> / 4096
        </div>
        <div class="formatting-help">
            üí° –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: <code>&lt;b&gt;—Ç–µ–∫—Å—Ç&lt;/b&gt;</code> ‚Äî –∂–∏—Ä–Ω—ã–π, 
            <code>&lt;i&gt;—Ç–µ–∫—Å—Ç&lt;/i&gt;</code> ‚Äî –∫—É—Ä—Å–∏–≤, 
            <code>&lt;code&gt;—Ç–µ–∫—Å—Ç&lt;/code&gt;</code> ‚Äî –∫–æ–¥
        </div>
    </div>

    <!-- –ú–µ–¥–∏–∞ -->
    <div class="section">
        <div class="section-title">
            <span>üñºÔ∏è</span>
            <span>–ú–µ–¥–∏–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
        </div>
        <div class="media-upload">
            <button class="upload-btn" onclick="document.getElementById('photoInput').click()">
                üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
            </button>
            <button class="upload-btn secondary" onclick="document.getElementById('videoInput').click()">
                üé• –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ
            </button>
            <input type="file" id="photoInput" accept="image/*" onchange="handleFileUpload(this, 'photo')">
            <input type="file" id="videoInput" accept="video/*" onchange="handleFileUpload(this, 'video')">
        </div>
        <div class="media-preview" id="mediaPreview">
            <div class="preview-item" id="previewItem">
                <button class="preview-remove" onclick="removeMedia()">√ó</button>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="section">
        <div class="section-title">
            <span>üîò</span>
            <span>–ö–Ω–æ–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
        </div>
        <div class="buttons-section" id="buttonsSection">
            <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <button class="add-button-btn" onclick="addButton()">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
        </button>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div class="section preview-section">
        <div class="section-title">
            <span>üëÅÔ∏è</span>
            <span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
        </div>
        <div class="preview-content" id="previewContent">
            <em style="color: var(--tg-theme-hint-color, #999);">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...</em>
        </div>
        <div class="preview-buttons" id="previewButtons"></div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É');
        tg.MainButton.show();

        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        let broadcastData = {
            text: '',
            media: null,
            buttons: []
        };

        // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
        const messageText = document.getElementById('messageText');
        const charCount = document.getElementById('charCount');
        
        messageText.addEventListener('input', function() {
            charCount.textContent = this.value.length;
            broadcastData.text = this.value;
            updatePreview();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
        function handleFileUpload(input, type) {
            const file = input.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
            const maxSize = type === 'photo' ? 10 * 1024 * 1024 : 50 * 1024 * 1024; // 10MB –¥–ª—è —Ñ–æ—Ç–æ, 50MB –¥–ª—è –≤–∏–¥–µ–æ
            if (file.size > maxSize) {
                showError(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º ${maxSize / 1024 / 1024}MB`);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const previewItem = document.getElementById('previewItem');
                const mediaPreview = document.getElementById('mediaPreview');
                
                // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
                const existingMedia = previewItem.querySelector('img, video, .file-info');
                if (existingMedia) existingMedia.remove();

                if (type === 'photo') {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    previewItem.insertBefore(img, previewItem.firstChild);
                } else if (type === 'video') {
                    const video = document.createElement('video');
                    video.src = e.target.result;
                    video.controls = true;
                    previewItem.insertBefore(video, previewItem.firstChild);
                }

                mediaPreview.classList.add('active');
                
                // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                broadcastData.media = {
                    type: type,
                    data: e.target.result,
                    name: file.name,
                    size: file.size
                };
            };
            reader.readAsDataURL(file);
        }

        function removeMedia() {
            document.getElementById('mediaPreview').classList.remove('active');
            document.getElementById('photoInput').value = '';
            document.getElementById('videoInput').value = '';
            broadcastData.media = null;
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
        let buttonCounter = 0;

        function addButton() {
            const buttonsSection = document.getElementById('buttonsSection');
            const buttonId = ++buttonCounter;
            
            const buttonItem = document.createElement('div');
            buttonItem.className = 'button-item';
            buttonItem.id = `button-${buttonId}`;
            buttonItem.innerHTML = `
                <input type="text" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" oninput="updateButton(${buttonId}, 'text', this.value)">
                <input type="url" placeholder="https://example.com" oninput="updateButton(${buttonId}, 'url', this.value)">
                <button class="btn-remove" onclick="removeButton(${buttonId})">√ó</button>
            `;
            
            buttonsSection.appendChild(buttonItem);
            
            // –î–æ–±–∞–≤–∏—Ç—å –≤ –¥–∞–Ω–Ω—ã–µ
            broadcastData.buttons.push({
                id: buttonId,
                text: '',
                url: ''
            });
        }

        function updateButton(id, field, value) {
            const button = broadcastData.buttons.find(b => b.id === id);
            if (button) {
                button[field] = value;
                updatePreview();
            }
        }

        function removeButton(id) {
            document.getElementById(`button-${id}`).remove();
            broadcastData.buttons = broadcastData.buttons.filter(b => b.id !== id);
            updatePreview();
        }

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        function updatePreview() {
            const previewContent = document.getElementById('previewContent');
            const previewButtons = document.getElementById('previewButtons');
            
            // –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
            if (broadcastData.text) {
                previewContent.innerHTML = broadcastData.text;
            } else {
                previewContent.innerHTML = '<em style="color: var(--tg-theme-hint-color, #999);">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞...</em>';
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
            previewButtons.innerHTML = '';
            broadcastData.buttons.forEach(btn => {
                if (btn.text && btn.url) {
                    const btnElement = document.createElement('a');
                    btnElement.className = 'preview-button';
                    btnElement.textContent = btn.text;
                    btnElement.href = btn.url;
                    btnElement.target = '_blank';
                    previewButtons.appendChild(btnElement);
                }
            });
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.classList.add('active');
            setTimeout(() => {
                errorMessage.classList.remove('active');
            }, 3000);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        tg.MainButton.onClick(function() {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!broadcastData.text && !broadcastData.media) {
                showError('‚ùå –î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –º–µ–¥–∏–∞');
                return;
            }

            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const dataToSend = {
                text: broadcastData.text,
                buttons: broadcastData.buttons.filter(b => b.text && b.url)
            };

            // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ–¥–∏–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
            if (broadcastData.media) {
                dataToSend.media_type = broadcastData.media.type;
                dataToSend.media_data = broadcastData.media.data;
            }

            // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
            tg.sendData(JSON.stringify(dataToSend));
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ WebApp
        tg.BackButton.show();
        tg.BackButton.onClick(function() {
            tg.close();
        });
    </script>
</body>
</html>
