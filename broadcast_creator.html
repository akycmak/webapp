<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #999);
        }

        .header-icon {
            font-size: 32px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .section {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--tg-theme-hint-color, #999);
            text-transform: uppercase;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        textarea, input[type="text"], input[type="url"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            resize: vertical;
        }

        textarea {
            min-height: 120px;
        }

        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        .upload-btn:active {
            opacity: 0.8;
        }

        .file-preview {
            display: none;
            padding: 12px;
            background: var(--tg-theme-bg-color, #fff);
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 8px;
            align-items: center;
            gap: 12px;
        }

        .file-preview.active {
            display: flex;
        }

        .file-preview img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .file-size {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
        }

        .remove-btn {
            padding: 8px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .button-item {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .button-item input {
            flex: 1;
        }

        .add-button-btn {
            width: 100%;
            padding: 10px;
            background: transparent;
            color: var(--tg-theme-button-color, #3390ec);
            border: 2px dashed var(--tg-theme-button-color, #3390ec);
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .preview-section {
            background: var(--tg-theme-bg-color, #fff);
            border: 2px solid var(--tg-theme-button-color, #3390ec);
            border-radius: 12px;
            padding: 16px;
        }

        .preview-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--tg-theme-button-color, #3390ec);
        }

        .preview-message {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .preview-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .preview-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .preview-button {
            padding: 10px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }

        .char-counter {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
            text-align: right;
            margin-top: 4px;
        }

        .hint {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 4px;
        }

        input[type="file"] {
            display: none;
        }

        .audience-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .audience-option {
            padding: 12px;
            background: var(--tg-theme-bg-color, #fff);
            border: 2px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .audience-option.selected {
            border-color: var(--tg-theme-button-color, #3390ec);
            background: rgba(51, 144, 236, 0.1);
        }

        .audience-option-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .audience-option-desc {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-icon">üé®</div>
        <div class="header-title">–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏</div>
    </div>

    <!-- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è -->
    <div class="section">
        <div class="section-title">üë• –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</div>
        <div class="audience-selector" id="audienceSelector">
            <div class="audience-option" data-type="all">
                <div class="audience-option-title">üì¢ –í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</div>
                <div class="audience-option-desc">–†–∞—Å—Å—ã–ª–∫–∞ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</div>
            </div>
            <div class="audience-option" data-type="loyalty">
                <div class="audience-option-title">üéØ –ü–æ —É—Ä–æ–≤–Ω—é –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
                <div class="audience-option-desc">–í—ã–±–æ—Ä–æ—á–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –ø–æ —É—Ä–æ–≤–Ω—é</div>
            </div>
        </div>
    </div>

    <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="section">
        <div class="section-title">üí¨ –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</div>
        <div class="input-group">
            <label class="input-label" for="messageText">–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏</label>
            <textarea 
                id="messageText" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è&#10;&#10;–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML:&#10;&lt;b&gt;–∂–∏—Ä–Ω—ã–π&lt;/b&gt;&#10;&lt;i&gt;–∫—É—Ä—Å–∏–≤&lt;/i&gt;&#10;&lt;code&gt;–∫–æ–¥&lt;/code&gt;"
                maxlength="4096"
            ></textarea>
            <div class="char-counter">
                <span id="charCount">0</span>/4096 —Å–∏–º–≤–æ–ª–æ–≤
            </div>
        </div>
    </div>

    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
    <div class="section">
        <div class="section-title">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
        <div class="file-upload">
            <input type="file" id="imageInput" accept="image/*">
            <button class="upload-btn" onclick="document.getElementById('imageInput').click()">
                <span>üì∑</span>
                <span>–í—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
            </button>
            <div class="file-preview" id="imagePreview">
                <img id="previewImg" src="" alt="Preview">
                <div class="file-info">
                    <div class="file-name" id="imageName"></div>
                    <div class="file-size" id="imageSize"></div>
                </div>
                <button class="remove-btn" onclick="removeImage()">‚úï</button>
            </div>
            <div class="hint">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 1200x630px, –º–∞–∫—Å. 5 –ú–ë</div>
        </div>
    </div>

    <!-- –§–∞–π–ª -->
    <div class="section">
        <div class="section-title">üìé –§–∞–π–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
        <div class="file-upload">
            <input type="file" id="fileInput">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                <span>üìÑ</span>
                <span>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</span>
            </button>
            <div class="file-preview" id="filePreview">
                <div class="file-info">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-size" id="fileSize"></div>
                </div>
                <button class="remove-btn" onclick="removeFile()">‚úï</button>
            </div>
            <div class="hint">PDF, DOCX, XLSX –∏ –¥—Ä—É–≥–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –º–∞–∫—Å. 20 –ú–ë</div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="section">
        <div class="section-title">üîò –ö–Ω–æ–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
        <div class="buttons-container" id="buttonsContainer"></div>
        <button class="add-button-btn" onclick="addButton()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É</button>
        <div class="hint">–ú–∞–∫—Å–∏–º—É–º 10 –∫–Ω–æ–ø–æ–∫</div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div class="section preview-section">
        <div class="preview-title">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</div>
        <img id="previewMessageImage" class="preview-image" style="display: none;">
        <div class="preview-message" id="previewMessage">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...</div>
        <div class="preview-buttons" id="previewButtons"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        let selectedAudience = 'all';
        let imageFile = null;
        let attachedFile = null;
        let buttons = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            // –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.querySelector('.audience-option[data-type="all"]').classList.add('selected');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.querySelectorAll('.audience-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.audience-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedAudience = option.dataset.type;
                });
            });

            document.getElementById('messageText').addEventListener('input', updatePreview);
            document.getElementById('imageInput').addEventListener('change', handleImageSelect);
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram
            tg.MainButton.setText('–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É');
            tg.MainButton.onClick(() => sendBroadcast());
            tg.MainButton.show();
        });

        function updatePreview() {
            const text = document.getElementById('messageText').value;
            document.getElementById('charCount').textContent = text.length;
            
            const preview = document.getElementById('previewMessage');
            preview.innerHTML = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\*\*(.+?)\*\*/g, '<b>$1</b>')
                .replace(/\*(.+?)\*/g, '<i>$1</i>')
                .replace(/`(.+?)`/g, '<code>$1</code>')
                || '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...';
        }

        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                tg.showAlert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 5 –ú–ë');
                return;
            }

            imageFile = file;
            document.getElementById('imageName').textContent = file.name;
            document.getElementById('imageSize').textContent = formatFileSize(file.size);
            document.getElementById('imagePreview').classList.add('active');

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('previewMessageImage').src = e.target.result;
                document.getElementById('previewMessageImage').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 20 * 1024 * 1024) {
                tg.showAlert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 20 –ú–ë');
                return;
            }

            attachedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('filePreview').classList.add('active');
        }

        function removeImage() {
            imageFile = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreview').classList.remove('active');
            document.getElementById('previewMessageImage').style.display = 'none';
        }

        function removeFile() {
            attachedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').classList.remove('active');
        }

        function addButton() {
            if (buttons.length >= 10) {
                tg.showAlert('–ú–∞–∫—Å–∏–º—É–º 10 –∫–Ω–æ–ø–æ–∫');
                return;
            }

            const buttonId = Date.now();
            buttons.push({ id: buttonId, text: '', url: '' });

            const container = document.getElementById('buttonsContainer');
            const buttonItem = document.createElement('div');
            buttonItem.className = 'button-item';
            buttonItem.id = `button-${buttonId}`;
            buttonItem.innerHTML = `
                <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                    <input type="text" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" onchange="updateButtonText(${buttonId}, this.value)">
                    <input type="url" placeholder="https://..." onchange="updateButtonUrl(${buttonId}, this.value)">
                </div>
                <button class="remove-btn" onclick="removeButton(${buttonId})">‚úï</button>
            `;
            container.appendChild(buttonItem);
        }

        function updateButtonText(id, text) {
            const button = buttons.find(b => b.id === id);
            if (button) {
                button.text = text;
                updateButtonsPreview();
            }
        }

        function updateButtonUrl(id, url) {
            const button = buttons.find(b => b.id === id);
            if (button) {
                button.url = url;
                updateButtonsPreview();
            }
        }

        function removeButton(id) {
            buttons = buttons.filter(b => b.id !== id);
            document.getElementById(`button-${id}`).remove();
            updateButtonsPreview();
        }

        function updateButtonsPreview() {
            const preview = document.getElementById('previewButtons');
            preview.innerHTML = '';
            buttons.forEach(btn => {
                if (btn.text && btn.url) {
                    const buttonEl = document.createElement('div');
                    buttonEl.className = 'preview-button';
                    buttonEl.textContent = btn.text;
                    preview.appendChild(buttonEl);
                }
            });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' –ë';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' –ö–ë';
            return (bytes / (1024 * 1024)).toFixed(1) + ' –ú–ë';
        }

        async function sendBroadcast() {
            const text = document.getElementById('messageText').value.trim();

            if (!text) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }

            tg.MainButton.showProgress();

            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const data = {
                audience: selectedAudience,
                text: text,
                buttons: buttons.filter(b => b.text && b.url),
                hasImage: !!imageFile,
                hasFile: !!attachedFile
            };

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (–±–æ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç —Ñ–∞–π–ª—ã –æ—Ç–¥–µ–ª—å–Ω–æ)
            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>

